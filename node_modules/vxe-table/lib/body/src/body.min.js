"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _ctor=_interopRequireDefault(require("xe-utils/ctor")),_conf=_interopRequireDefault(require("../../conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,l){if(e){if("string"==typeof e)return _arrayLikeToArray(e,l);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,l):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,l){(null==l||l>e.length)&&(l=e.length);for(var t=0,r=new Array(l);t<l;t++)r[t]=e[t];return r}function _defineProperty(e,l,t){return l in e?Object.defineProperty(e,l,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[l]=t,e}var scrollProcessTimeout,cellType="body";function isOperateMouse(e){return e._isResize||e.lastScrollTime&&Date.now()<e.lastScrollTime+e.delayHover}function countTreeExpand(e,l){var t=l.$table,r=e[t.treeOpts.children],o=1;if(t.isTreeExpandByRow(e))for(var n=0;n<r.length;n++)o+=countTreeExpand(r[n],l);return o}function getOffsetSize(e){switch(e.vSize){case"mini":return 3;case"small":return 2;case"medium":return 1}return 0}function calcTreeLine(e,l){var t=e.$table,r=e.$rowIndex,o=1;return r&&(o=countTreeExpand(l[r-1],e)),t.rowHeight*o-(r?1:12-getOffsetSize(t))}function renderLine(e,l,t,r,o,n){var a=n.column,s=t.treeOpts,i=t.treeConfig;return a.slots&&a.slots.line?a.slots.line.call(t,n,e):a.treeNode&&i&&s.line?[e("div",{class:"vxe-tree--line-wrapper"},[e("div",{class:"vxe-tree--line",style:{height:"".concat(calcTreeLine(n,o),"px"),left:"".concat(r*s.indent+(r?2-getOffsetSize(t):0)+16,"px")}})])]:[]}function renderBorder(e,l){return e("div",{class:"vxe-table-".concat(l,"ed-borders"),ref:"".concat(l,"Borders")},[e("span",{class:"vxe-table-border-top",ref:"".concat(l,"Top")}),e("span",{class:"vxe-table-border-right",ref:"".concat(l,"Right")}),e("span",{class:"vxe-table-border-bottom",ref:"".concat(l,"Bottom")}),e("span",{class:"vxe-table-border-left",ref:"".concat(l,"Left")})])}function mergeMethod(e,l,t){for(var r=0;r<e.length;r++){var o=e[r],n=o.row,a=o.col,s=o.rowspan,i=o.colspan;if(-1<a&&-1<n&&s&&i){if(n===l&&a===t)return{rowspan:s,colspan:i};if(n<=l&&l<n+s&&a<=t&&t<a+i)return{rowspan:0,colspan:0}}}}function renderColumn(e,l,t,r,o,n,a,s,i,c,d,u,p,f,y,v){var g,b,x=t._e,m=t.$listeners,h=t.afterFullData,w=t.tableData,_=t.height,T=t.columnKey,S=t.overflowX,C=t.scrollXLoad,O=t.scrollYLoad,$=t.highlightCurrentRow,L=t.showOverflow,k=t.align,E=t.currentColumn,I=t.cellClassName,R=t.cellStyle,A=t.mergeList,B=t.spanMethod,P=t.radioOpts,q=t.checkboxOpts,M=t.expandOpts,D=t.treeOpts,H=t.tooltipOpts,j=t.mouseConfig,N=t.editConfig,U=t.editOpts,X=t.editRules,z=t.validOpts,F=t.editStore,W=t.validStore,Y=p.cellRender,V=p.editRender,K=p.align,G=p.showOverflow,J=p.className,Q=p.treeNode,Z=F.actived,ee=H.showAll||H.enabled,le=t.getColumnIndex(p),te=t.getVTColumnIndex(p),re=_tools.UtilTools.isEnableConf(V),oe=a?p.fixed!==a:p.fixed&&S,ne=_ctor.default.isUndefined(G)||_ctor.default.isNull(G)?L:G,ae="ellipsis"===ne,se="title"===ne,ie=!0===ne||"tooltip"===ne,ce=se||ie||ae,de={},ue=K||k,pe=W.row===i&&W.column===p,fe=X&&z.showMessage&&("default"===z.message?_||1<w.length:"inline"===z.message),ye={"data-colid":p.id},ve=m["cell-mouseenter"],ge=m["cell-mouseleave"],be=V&&N&&"dblclick"===U.trigger,xe={$table:t,$seq:r,seq:o,rowid:n,row:i,rowIndex:c,$rowIndex:d,_rowIndex:u,column:p,columnIndex:le,$columnIndex:f,_columnIndex:te,fixed:a,type:cellType,isHidden:oe,level:s,visibleData:h,data:w,items:v};if(!C&&!O||ce||(ae=ce=!0),(se||ie||ee||ve)&&(de.mouseenter=function(e){isOperateMouse(t)||(se?_tools.DomTools.updateCellTitle(e.currentTarget,p):(ie||ee)&&t.triggerBodyTooltipEvent(e,xe),ve&&t.emitEvent("cell-mouseenter",Object.assign({cell:e.currentTarget},xe),e))}),(ie||ee||ge)&&(de.mouseleave=function(e){isOperateMouse(t)||((ie||ee)&&t.handleTargetLeaveEvent(e),ge&&t.emitEvent("cell-mouseleave",Object.assign({cell:e.currentTarget},xe),e))}),(q.range||j)&&(de.mousedown=function(e){t.triggerCellMousedownEvent(e,xe)}),($||j||m["cell-click"]||V&&N||"row"===M.trigger||"cell"===M.trigger||"row"===P.trigger||"radio"===p.type&&"cell"===P.trigger||"row"===q.trigger||("checkbox"===p.type||"selection"===p.type)&&"cell"===q.trigger||"row"===D.trigger||p.treeNode&&"cell"===D.trigger)&&(de.click=function(e){t.triggerCellClickEvent(e,xe)}),(be||m["cell-dblclick"])&&(de.dblclick=function(e){t.triggerCellDBLClickEvent(e,xe)}),A.length){var me=mergeMethod(A,u,te);if(me){var he=me.rowspan,we=me.colspan;if(!he||!we)return null;1<he&&(ye.rowspan=he),1<we&&(ye.colspan=we)}}else if(B){var _e=B(xe)||{},Te=_e.rowspan,Se=void 0===Te?1:Te,Ce=_e.colspan,Oe=void 0===Ce?1:Ce;if(!Se||!Oe)return null;1<Se&&(ye.rowspan=Se),1<Oe&&(ye.colspan=Oe)}oe&&A&&(1<ye.colspan||1<ye.rowspan)&&(oe=!1),!oe&&N&&(V||Y)&&U.showStatus&&(b=t.isUpdateByRow(i,p.property));var $e="seq"===p.type||"index"===p.type?"seq":p.type;return e("td",{class:["vxe-body--column",p.id,(g={},_defineProperty(g,"col--".concat(ue),ue),_defineProperty(g,"col--".concat($e),$e),_defineProperty(g,"col--last",f===y.length-1),_defineProperty(g,"col--tree-node",Q),_defineProperty(g,"col--edit",re),_defineProperty(g,"col--ellipsis",ce),_defineProperty(g,"fixed--hidden",oe),_defineProperty(g,"col--dirty",b),_defineProperty(g,"col--actived",N&&re&&Z.row===i&&(Z.column===p||"row"===U.mode)),_defineProperty(g,"col--valid-error",pe),_defineProperty(g,"col--current",E===p),g),_tools.UtilTools.getClass(J,xe),_tools.UtilTools.getClass(I,xe)],key:T?p.id:f,attrs:ye,style:R?_ctor.default.isFunction(R)?R(xe):R:null,on:de},L&&oe?[e("div",{class:["vxe-cell",{"c--title":se,"c--tooltip":ie,"c--ellipsis":ae}]})]:renderLine(e,l,t,s,v,xe).concat([e("div",{class:["vxe-cell",{"c--title":se,"c--tooltip":ie,"c--ellipsis":ae}],attrs:{title:se?t.getCellLabel(i,p):null}},p.renderCell(e,xe)),fe?pe?e("div",{class:"vxe-cell--valid",style:W.rule&&W.rule.maxWidth?{width:"".concat(W.rule.maxWidth,"px")}:null},[e("span",{class:"vxe-cell--valid-msg"},W.content)]):x():null]))}function renderRows(y,v,g,b,x,m,h,w){var _=g.stripe,T=g.rowKey,S=g.highlightHoverRow,C=g.rowClassName,O=g.rowStyle,$=g.showOverflow,L=g.treeConfig,k=g.treeOpts,E=g.treeExpandeds,I=g.scrollYLoad,R=g.scrollYStore,A=g.editStore,B=g.rowExpandeds,P=g.radioOpts,q=g.checkboxOpts,M=g.expandColumn,D=[];return h.forEach(function(t,r){var e={},o=r,n=o+1;I&&(n+=R.startIndex);var a=g.getVTRowIndex(t);o=g.getRowIndex(t),S&&(e.mouseenter=function(e){isOperateMouse(g)||g.triggerHoverEvent(e,{row:t,rowIndex:o})},e.mouseleave=function(){isOperateMouse(g)||g.clearHoverRow()});var s=_tools.UtilTools.getRowid(g,t),l={$table:g,$seq:b,seq:n,rowid:s,fixed:m,type:cellType,level:x,row:t,rowIndex:o,$rowIndex:r};if(D.push(y("tr",{class:["vxe-body--row",{"row--stripe":_&&(g.getVTRowIndex(t)+1)%2==0,"is--new":-1<A.insertList.indexOf(t),"row--radio":P.highlight&&g.selectRow===t,"row--checked":q.highlight&&g.isCheckedByCheckboxRow(t)},C?_ctor.default.isFunction(C)?C(l):C:""],attrs:{"data-rowid":s},style:O?_ctor.default.isFunction(O)?O(l):O:null,key:T||L?s:r,on:e},w.map(function(e,l){return renderColumn(y,v,g,b,n,s,m,x,t,o,r,a,e,l,w,h)}))),M&&B.length&&-1<B.indexOf(t)){var i,c=g.getColumnIndex(M);L&&(i={paddingLeft:"".concat(x*k.indent+30,"px")});var d=M.showOverflow,u=_ctor.default.isUndefined(d)||_ctor.default.isNull(d)?$:d,p={$table:g,$seq:b,seq:n,column:M,columnIndex:c,fixed:m,type:cellType,level:x,row:t,rowIndex:o,$rowIndex:r};D.push(y("tr",{class:"vxe-body--expanded-row",key:"expand_".concat(s),style:O?_ctor.default.isFunction(O)?O(p):O:null,on:e},[y("td",{class:["vxe-body--expanded-column",{"fixed--hidden":m,"col--ellipsis":u}],attrs:{colspan:w.length}},[y("div",{class:"vxe-body--expanded-cell",style:i},[M.renderData(y,p)])])]))}if(L&&E.length){var f=t[k.children];f&&f.length&&-1<E.indexOf(t)&&D.push.apply(D,_toConsumableArray(renderRows(y,v,g,b?"".concat(b,".").concat(n):"".concat(n),x+1,m,f,w)))}}),D}function syncBodyScroll(e,l,t){(l||t)&&(l&&(l.onscroll=null,l.scrollTop=e),t&&(t.onscroll=null,t.scrollTop=e),clearTimeout(scrollProcessTimeout),scrollProcessTimeout=setTimeout(function(){l&&(l.onscroll=l._onscroll),t&&(t.onscroll=t._onscroll)},300))}var _default={name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,visibleColumn:Array,fixedColumn:Array,size:String,fixedType:String,isGroup:Boolean},mounted:function(){var e=this.$parent,l=this.$el,t=this.$refs,r=this.fixedType,o=e.elemStore,n="".concat(r||"main","-body-");o["".concat(n,"wrapper")]=l,o["".concat(n,"table")]=t.table,o["".concat(n,"colgroup")]=t.colgroup,o["".concat(n,"list")]=t.tbody,o["".concat(n,"xSpace")]=t.xSpace,o["".concat(n,"ySpace")]=t.ySpace,o["".concat(n,"emptyBlock")]=t.emptyBlock,this.$el.onscroll=this.scrollEvent,this.$el._onscroll=this.scrollEvent},beforeDestroy:function(){this.$el._onscroll=null,this.$el.onscroll=null},render:function(t){var e,l=this._e,r=this.$parent,o=this.fixedColumn,n=this.fixedType,a=r.$scopedSlots,s=r.tId,i=r.tableData,c=r.tableColumn,d=r.showOverflow,u=r.mergeList,p=r.spanMethod,f=r.scrollXLoad,y=r.mouseConfig,v=r.mouseOpts,g=r.emptyRender,b=r.emptyOpts,x=r.keyboardConfig,m=r.keyboardOpts,h=y&&v.checked;if(u.length||p||x&&m.isMerge||(n&&d?c=o:f&&n&&(c=o)),a.empty)e=a.empty.call(this,{$table:r},t);else{var w=g?_vXETable.default.renderer.get(b.name):null;e=w&&w.renderEmpty?w.renderEmpty.call(this,t,b,{$table:r},{$table:r}):r.emptyText||_conf.default.i18n("vxe.table.emptyText")}return t("div",{class:["vxe-table--body-wrapper",n?"fixed-".concat(n,"--wrapper"):"body--wrapper"],attrs:{"data-tid":s}},[n?l():t("div",{class:"vxe-body--x-space",ref:"xSpace"}),t("div",{class:"vxe-body--y-space",ref:"ySpace"}),t("table",{class:"vxe-table--body",attrs:{"data-tid":s,cellspacing:0,cellpadding:0,border:0},ref:"table"},[t("colgroup",{ref:"colgroup"},c.map(function(e,l){return t("col",{attrs:{name:e.id},key:l})})),t("tbody",{ref:"tbody"},renderRows(t,this,r,"",0,n,i,c))]),n||!h&&!m.isCut?null:t("div",{class:"vxe-table--borders"},[h?renderBorder(t,"check"):null,m.isCut?renderBorder(t,"copy"):null]),t("div",{class:"vxe-table--checkbox-range"}),y&&v.area?t("div",{class:"vxe-table--cell-area"},[t("span",{class:"vxe-table--cell-main-area"},v.extension?[t("span",{class:"vxe-table--cell-main-area-btn",on:{mousedown:function(e){r.triggerCellExtendMousedownEvent(e,{$table:r,fixed:n,type:cellType})}}})]:null),t("span",{class:"vxe-table--cell-copy-area"}),t("span",{class:"vxe-table--cell-extend-area"}),t("span",{class:"vxe-table--cell-multi-area"}),t("span",{class:"vxe-table--cell-active-area"})]):null,n?null:t("div",{class:"vxe-table--empty-block",ref:"emptyBlock"},[t("div",{class:"vxe-table--empty-content"},e)])])},methods:{scrollEvent:function(e){var l=this.$el,t=this.$parent,r=this.fixedType,o=t.$refs,n=t.highlightHoverRow,a=t.scrollXLoad,s=t.scrollYLoad,i=t.lastScrollTop,c=t.lastScrollLeft,d=o.tableHeader,u=o.tableBody,p=o.leftBody,f=o.rightBody,y=o.tableFooter,v=o.validTip,g=d?d.$el:null,b=y?y.$el:null,x=u.$el,m=p?p.$el:null,h=f?f.$el:null,w=l.scrollTop,_=x.scrollLeft,T=_!==c,S=w!==i;t.lastScrollTop=w,t.lastScrollLeft=_,t.lastScrollTime=Date.now(),n&&t.clearHoverRow(),m&&"left"===r?syncBodyScroll(w=m.scrollTop,x,h):h&&"right"===r?syncBodyScroll(w=h.scrollTop,x,m):(T&&(g&&(g.scrollLeft=x.scrollLeft),b&&(b.scrollLeft=x.scrollLeft)),(m||h)&&(t.checkScrolling(),S&&syncBodyScroll(w,m,h))),a&&T&&(t.triggerScrollXEvent(e),g&&_+x.clientWidth>=x.scrollWidth-80&&this.$nextTick(function(){x.scrollLeft!==g.scrollLeft&&(g.scrollLeft=x.scrollLeft)})),s&&S&&t.triggerScrollYEvent(e),T&&v&&v.visible&&v.updatePlacement(),t.emitEvent("scroll",{type:cellType,fixed:r,scrollTop:w,scrollLeft:_,isX:T,isY:S},e)}}};exports.default=_default;